services:
  classification:
    build:
      context: .
      dockerfile: classification/Dockerfile
    container_name: classification
    environment:
      DB_USER: root
      DB_PASS: pass
      DB_HOST: napi_db
      DB_PORT: 3306
      LOG_LEVEL: DEBUG
    tty: true
    stdin_open: true
    networks:
      - iot_network

  predict:
    build:
      context: .
      dockerfile: predict/Dockerfile
    container_name: predict
    environment:
      DB_USER: root
      DB_PASS: pass
      DB_HOST: napi_db
      DB_PORT: 3306
      LOG_LEVEL: DEBUG
      USE_FIXED_DATE: ${USE_FIXED_DATE} # .envより
      WEATHER_SERVER_DOMAIN: ${WEATHER_SERVER_DOMAIN} #.envより
      WEATHER_SERVER_KEY: ${WEATHER_SERVER_KEY} #.envより
    tty: true
    stdin_open: true
    volumes:
      - ./predict/model:/gcs/model
    networks:
      - iot_network

  roof:
    build:
      context: ./roof
      dockerfile: Dockerfile
    container_name: roof
    environment:
      - USE_MOCK_MODEL=${USE_MOCK_MODEL:-false}
      # 可通过 ROOF_MODEL_PATH 指定生产权重路径（容器内路径）
      - ROOF_MODEL_PATH=${ROOF_MODEL_PATH:-/models/roof_best.pt}
    volumes:
      # 将生产环境的权重文件挂载到容器内部固定路径
      - ${ROOF_MODEL_HOST_PATH:-./roof/best_v2.pt}:/models/roof_best.pt:ro
    networks:
      - iot_network
    ports:
      - "8000:8000"


  # Healthcheck container for roof (optional, curl-based)
  roof-health:
    image: curlimages/curl:8.8.0
    depends_on:
      - roof
    command: ["sh", "-c", "curl -sf http://roof:8000/docs >/dev/null && echo healthy || (echo unhealthy && exit 1)"]
    networks:
      - iot_network

networks:
  iot_network:
    external: true
